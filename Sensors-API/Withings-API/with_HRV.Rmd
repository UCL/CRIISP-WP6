---
  title: "HRV"
output: 
  github_document:
  toc: True
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
  
  
```{r echo=F}
library("tidyr")
library("dplyr")
library("httr")
library("jsonlite")
```

## heart rate Variability

### RR peak detection

Fast implementation of Pan & Tompkins (1985) (PT algorithm).

The PT algorithm consists of 5 processes: 
  
  1 band-pass filter (BPF)
-> 2 derivative
-> 3 squaring
-> 4 moving window integration (MWI)
-> 5 R-peak detection

https://github.com/vankesteren/rpeaks

```{r}
#install.packages("rpeaks", repos = c("https://vankesteren.r-universe.dev", "https://cloud.r-project.org"))

library(rpeaks)
ECGraw.df<-ecg_data_list[[3]]
ecg_dat <- ECGraw.df$Value
ecg_sec <- (0:(length(ECGraw.df$Value) - 1)) / 300 # rel. time in seconds
r_peaks <- rpeaks_pan_tompkins(ecg = ecg_dat, sample_rate = 300)

#remotes::install_github("boupetch/rsleep")
library(rsleep)

peaks <- detect_rpeaks(ecg_dat, sRate = 300)
ecg.df <- data.frame(ECG = ecg_dat,Seconds = c(0:(length(ecg_dat)-1)/300))
ggplot(ecg.df,aes(x = Seconds,y = ECG)) +
  geom_line() + theme_bw() +
  geom_vline(data.frame(p = peaks),mapping = aes(xintercept = p), linetype="dashed",color = "red")+
  geom_vline(data.frame(p = r_peaks),mapping = aes(xintercept = p), linetype="dashed",color = "blue")


# Add the raw ECG signal to the HRVData structure
HRVData$ECG <- ecg.df$ECG  

# Now apply an R-peak detection algorithm (this is a placeholder)
HRVData <- DetectRPeaks(HRVData, method = "Wavelet")  # Example method for R-peak detection

```

# short term HRV

Two distinct but overlapping processes generate short-term HRV measurements. The first source is a complex and dynamic relationship between the sympathetic and parasympathetic branches. The second source includes the regulatory mechanisms that control HR via respiratory sinus arrhythmia (RSA), the baroreceptor reflex (negative-feedback control of BP), and rhythmic changes in vascular tone (2). RSA refers to the respiration-driven speeding and slowing of the heart via the vagus nerve (14).
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5624990/

In short-term resting recordings, the primary source of the variation is parasympathetically-mediated RSA, especially with slow, paced breathing (PB) protocols 

To calculate Heart Rate Variability (HRV) from ECG data in R, we use "RHRV" package.
```{r}
library(RHRV)

hrv.data <- CreateHRVData()
hrv.data <- SetVerbose(hrv.data, TRUE)
```

RHRV uses a custom data structure called HRVData to store all HRV information
related to the signal being analyzed. HRVData is implemented as a list object in R
language. This list contains all the information corresponding to the imported signal
to be analyzed, some parameters generated by the pre-processing functions and the
HRV analysis results. A new HRVData structure is created using the CreateHRVData
function. In order to obtain detailed information about the operations performed by
the program, we can activate a verbose mode using the SetVerbose function.

##  Load heart beat positions


```{r}

ECGdatetime<-ECGraw.df$start_date[1] %>% format("%d/%m/%Y %H:%M:%S")
  
hrv.data <- LoadBeatVector(hrv.data, datetime = ECGdatetime, beatPositions = peaks, scale = 1)

```

## Calculating HR and filtering

To compute the HRV time series the BuildNIHR function can be used (Build Non
Interpolated Heart Rate). This function constructs both the RR (Equation 2.1) and
instantaneous heart rate (HR) series (Equation 2.2) described in Section 2.1. We
will refer to the instantaneous heart rate (HR) as the Non Interpolated Heart Rate
(niHR) series. Both series are stored in the HRVData structure.


```{r}

hrv.data <- BuildNIHR(hrv.data)


```
A filtering operation must be carried out in order to eliminate outliers or spurious
points present in the niHR time series with unacceptable physiological values.
Outliers present in the series originate both from detecting an artifact as a heartbeat
(RR interval too short) or not detecting a heartbeat (RR interval too large). The
outliers removal may be both manual or automatic. In this quick introduction, we
will use the automatic removal. The automatic removal of spurious points can be
performed by the FilterNIHR function. The FilterNIHR function also eliminates 
points with unacceptable physiological values.

```{r}
 hrv.data = FilterNIHR(hrv.data)

```

## Interpolating
In order to be able to perform spectral analysis in the frequency domain, a uniformly
sampled HR series is required. It may be constructed from the niHR series by using
the InterpolateNIHR function, which uses linear (default) or spline interpolation
(further details on chapter 5). The frequency of interpolation may be specified.
4Hz (the default value) is enough for most applications.
```{r}
hrv.data = InterpolateNIHR (hrv.data, freqhr = 4)

```

## Plotting
Before applying the different analysis techniques that RHRV provides, it is usually
interesting to plot the time series with which we are working. The PlotNIHR
function permits the graphical representation of the niHR series whereas the PlotHR
function permits to graphically represent the interpolated HR time series.

```{r}
PlotNIHR(hrv.data)
PlotHR(hrv.data)
```

##  Time-domain analysis techniques

The best known time analysis statistic may be the standard deviation of the RR
interval: Standard Deviation of the NN interval (SDNN).

with these two statistical time domain indices being the least affected by 
length of data series (https://www.mdpi.com/1424-8220/21/18/6286):

RMSDD : Root Mean Square of Successive Differences.
pNN50 : proportion of successive RR intervals greater than 50 ms

*RMSSD* typically provides a better assessment of RSA (especially in older subjects) 
and most researchers prefer it to the pNN50 (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5624990/)


The RMSSD reflects the beat-to-beat variance in HR and is the primary 
time-domain measure used to estimate the vagally mediated changes reflected in HRV.

RMSSD is reliable to detect changes due to stress in 30s measurements (https://pubmed.ncbi.nlm.nih.gov/18003044/)

RMSSD is reliable to estimate HRV in 30s length RR time series
https://www.liebertpub.com/doi/10.1089


```{r}
 hrv.data = CreateTimeAnalysis(hrv.data, size = 30, interval = 7.8125)
```


## Frequency domain analysis

The basic frequency domain analysis technique is the Power Spectrum Density
(PSD). It provides basic information on how power distributes as a function of frequency in the RR time series. 

Since the sympathetic an parasympathetic branches of
the ANS are associated with different frequency bands, the PSD may be a useful tool
to discriminate its different contributions to the HR. The most common approach to
spectral analysis of HRV is based on the Fourier transform.

When working with frequency methods, researchers are especially interested in the
VLF, LF and HF frequency bands.

*HF* is reliable to estimate HRV in 30s length RR time series
https://www.liebertpub.com/doi/10.1089

```{r}
hrv.data = CreateFreqAnalysis(hrv.data)
hrv.data = SetVerbose(hrv.data,TRUE)

```

The most important function to perform spectral HRV analysis is the CalculatePowerBand function. 

The CalculatePowerBand function computes the spectrogram of the HR series in the ULF, VLF, LF and HF frequency bands using STFT
or wavelets. Boundaries of the bands may be chosen by the user. If boundaries are
not specified, default values are used: 

ULF, [0, 0.03] Hz; 
VLF, [0.03, 0.05] Hz; 
LF, [0.05, 0.15] Hz; 
HF, [0.15, 0.4] Hz. 

The type of analysis can be selected by the user
by specifying the type parameter of the CalculatePowerBand function. The possible
options are either “fourier” or “wavelet”. Because of the backwards compatibility,
the default value for this parameter is “fourier”.

When using the STFT to compute the spectrogram employing the CalculatePowerBand function, the user may specify the following parameters related with the STFT:

• Size: the size of window for calculating the spectrogram measured in seconds.
The RHRV package employs a Hamming window to perform the STFT.

• Shift: the displacement of window for calculating the spectrogram measured
in seconds.

• Sizesp: the number of points for calculating each window of the STFT. Thus,
it is highly recommended to select sizesp so that sizesp = 2N . If the user does
not specify it, the program selects a proper length for the calculations.

```{r}

hrv.data = CalculatePowerBand(hrv.data , type = "fourier", indexFreqAnalysis= 1, size = 10, shift = 5 )
PlotPowerBand(hrv.data, indexFreqAnalysis = 1)


spectrogram = CalculateSpectrogram( hrv.data ,size = 10, shift = 5, sizesp = 2048)
spectrogram = PlotSpectrogram(hrv.data, size=10, shift=5,  sizesp=2048)

```